<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.70.0" />

    
    
    

<title>Simpler File Encryption on iOS • Andy Ibanez</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Simpler File Encryption on iOS"/>
<meta name="twitter:description" content="Learn how to use the Data Protection APIs on iOS and iPadOS."/>

<meta property="og:title" content="Simpler File Encryption on iOS" />
<meta property="og:description" content="Learn how to use the Data Protection APIs on iOS and iPadOS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.andyibanez.com/posts/simpler-file-encryption-ios/" />
<meta property="article:published_time" content="2020-08-19T07:00:00-04:00" />
<meta property="article:modified_time" content="2020-08-19T07:00:00-04:00" /><meta property="og:site_name" content="Andy Ibanez - iOS Developer" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.e4368406c047b72036bd31fdf69f74f805156724914c166a0accb2369a218b61.css" integrity="sha256-5DaEBsBHtyA2vTH99p90&#43;AUVZySRTBZqCsyyNpohi2E=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    <script data-ad-client="ca-pub-3640551804216350" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-146179797-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.andyibanez.com">Andy Ibanez</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/196dd48d2ac425661edf58028d499370?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Software Developer from La Paz, Bolivia. Programming for iOS since 2011. 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Andy Ibanez</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/wwdc2020/">
						<span>WWDC 2020</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/projects/">
						<span>Projects</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/privacy-policy/">
						<span>Privacy Policy</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/AndyIbanezK" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://facebook.com/AndyIbanezCom" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/andyibanez" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/andyibanez" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/andr%c3%a9s-iba%c3%b1ez-30234033" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/648767" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://keybase.io/andyibanez" rel="me"><i class="fab fa-keybase fa-lg" aria-hidden="true"></i></a>
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2021 Andrés Ibañez
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Simpler File Encryption on iOS</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Aug 19, 2020
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/development">DEVELOPMENT</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/swift">swift</a>
           
      
          <a class="badge badge-tag" href="/tags/programming">programming</a>
           
      
          <a class="badge badge-tag" href="/tags/apple">apple</a>
           
      
          <a class="badge badge-tag" href="/tags/ios">ios</a>
           
      
          <a class="badge badge-tag" href="/tags/ipados">ipados</a>
           
      
          <a class="badge badge-tag" href="/tags/encryption">encryption</a>
           
      
          <a class="badge badge-tag" href="/tags/cryptography">cryptography</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  <div class="post">
    <p>It&rsquo;s not news that iOS has a heavy a focus on privacy and security. Apple provides us with many tools to make encryption easy, like <a href="https://www.andyibanez.com/posts/common-cryptographic-operations-with-cryptokit/">CryptoKit</a>, a high-level Cryptography framework on iOS. When <a href="https://www.andyibanez.com/posts/cryptokit-not-enough/">CryptoKit is not enough</a>, we can leverage older, lower-level APIs to do more cryptographic operations or use cyphers not covered by CryptoKit. We can even make use of <a href="https://www.andyibanez.com/posts/cryptokit-secure-enclave/">the Secure Enclave</a> to leverage hardware-level security to our apps.</p>
<p>This is all cool and dandy but did you know that you don&rsquo;t need to leverage any of the technologies above to secure data in your app? In this article we will provide a much simpler method to protect user data, without having to know the first thing about Cryptography at all, and without compromising security at all. If you know you need to protect data, you can consider this option before even considering directly dealing with cryptography at all.</p>
<h1 id="data-protection-on-ios">Data Protection on iOS</h1>
<p>Data Protection is an iOS feature that is automatically enabled the moment a passcode is set on the device. As this is enabled automatically, you get a lot of encryption support for free on your apps. You do not need to do anything especial when reading and writing files to ensure they are protected by Data Protection. Instead, you just use all reading and writing APIs as you would normally do, and the system will take care of encryption on the fly for you. This process is automatic, and when available, they use hardware-accelerated features.</p>
<p>So just by having a passcode, your data is already pretty secure. But to what extent? Is all my user data automatically safe just because a passcode is set? Well, no. But it&rsquo;s pretty darn close.</p>
<p>You can actually specify the data protection level on a file by file basis. You can apply any of four different levels to your files, and each level defines the conditions under which files may be accessed:</p>
<ul>
<li><strong>No Protection</strong>: The file will always be accessible whether there is a passcode set or not.</li>
<li><strong>Complete Until First Authentication</strong>: The file will not be accessible until the user authenticates for the first time (after a reboot, etc). After unlocking the device, the file becomes accessible at all times, whether the device is currently locked or not. This is the device protection level.</li>
<li><strong>Complete Unless Open</strong>: You will only be able to open the file while the device is unlocked, but once you have it open, you can continue accessing it even after the user locks the device. You can create files with this protection level whether the device is locked or unlocked.</li>
<li><strong>Complete</strong>: You will only be able to access this file when the device is unlocked. No questions asked.</li>
</ul>
<p>Since <code>Complete Until First Authentication</code> is the default level, your files are actually quite out there. This is not necessarily a bad thing, but be aware you can make your data be accessed only while the device is unlocked. Consider your use case, and apply the right data protection level as you deem fit.</p>
<h2 id="applying-a-different-data-protection-level-to-your-files">Applying a Different Data Protection Level to Your Files</h2>
<p>Applying a different file protection level to a file is as easy as calling <code>Data.write(to:options)</code> on a piece of <code>Data</code> you want to store. In the <code>options</code> parameter (of type <code>NSData.WritingOptions</code>), you can pass in the protection level you want to use:</p>
<ul>
<li><code>.noFileProtection</code></li>
<li><code>.completeFileProtectionUntilFirstUserAuthentication</code> (default)</li>
<li><code>.completeFileProtectionUnlessOpen</code></li>
<li><code>.completeFileProtection</code></li>
</ul>
<p>A small sample code would look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> fileURL = <span style="color:#75715e">// ...</span>
<span style="color:#66d9ef">let</span> data = <span style="color:#75715e">// ...</span>
<span style="color:#66d9ef">let</span> protectionLevel = Data.WritingOptions.completeFileProtection

<span style="color:#66d9ef">do</span> {
    <span style="color:#66d9ef">try</span> data.write(to: fileURL, options: protectionLevel)
}
<span style="color:#66d9ef">catch</span> {
   <span style="color:#75715e">// Handle errors.</span>
}
</code></pre></div><p>And that&rsquo;s it! Once you save your data to a file, it will apply the protection level you want, protecting your data to the level you specify.</p>
<h2 id="changing-the-protection-level-of-a-file">Changing the Protection Level of a File</h2>
<p>You can change the protection level of a file any time. The API is a bit messy at the time of this writing - it&rsquo;s Objective-C, so you need to cast, and you can&rsquo;t use the same <code>Data.WritingOptions</code> to change it, making it less intuitive. Luckily it&rsquo;s not too complicated.</p>
<p>To change the protection level, you need to use <code>NSURL</code>'s <code>setResourceValue(forKey:)</code> method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">do</span> {
   <span style="color:#66d9ef">try</span> (fileURL <span style="color:#66d9ef">as</span> NSURL).setResourceValue(
                  URLFileProtection.complete,
                  forKey: .fileProtectionKey)
}
<span style="color:#66d9ef">catch</span> {
   <span style="color:#75715e">// Handle errors.</span>
}
</code></pre></div><p><code>URLFileProtection</code> allows you to specify <code>.none</code>, <code>.completeUntilFirstUserAuthentication</code>, <code>.completeUnlessOpen</code>, and <code>.complete</code>.</p>
<h2 id="managing-protected-file-access">Managing Protected File Access</h2>
<p>Depending on the file level you specify, there is a chance you will try to access protected data without it being available. So you need to be responsible and handle opening and closing your files, especially when working with higher-level data protection settings.</p>
<p>For this reason, your App Delegate can implement <code> applicationProtectedDataWillBecomeUnavailable(_:)</code> and <code>applicationProtectedDataDidBecomeAvailable(_:)</code>.</p>
<p>Implementing this methods also implies using the right protection data level for each file. Files that may be accessed in the background due to tasks such as location, background push notifications, and the like, should have a flexible enough level to be accessible at all times.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Protecting data in your app doesn&rsquo;t have to be complicated. By leveraging this simple system you can protect your data without knowing the first word about Cryptography at all. Just be responsible and ensure you know what data protection level you need to assign to each file, and your data will be more secure without affecting performance or functionality in any way.</p>
<p>This article is based on Apple&rsquo;s <a href="https://developer.apple.com/documentation/uikit/protecting_the_user_s_privacy/encrypting_your_app_s_files">Encrypting Your App&rsquo;s Files</a> article.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/andyibanez-com-turns-one-year-old/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">andyibanez.com Turns One Year Old</span>
    </a>
    
    
    <a href="/posts/introduction-apples-unified-logging-system-ios14-swift/" class="navigation-next">
      <span class="navigation-tittle">Introduction to Apple&#39;s Unified Logging System on iOS 14 in Swift</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="AndyIbanez/andyibanez-com"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146179797-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/swift.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/objectivec.min.js"></script>
            
        
    
    <script type="text/javascript">
        
        hljs.configure({languages: ["swift, objectivec"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
