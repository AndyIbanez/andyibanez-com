<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.70.0" />

    
    
    

<title>Using the iOS Keychain in Swift • Andy Ibanez</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using the iOS Keychain in Swift"/>
<meta name="twitter:description" content="Learn how to use the iOS Keychain in Swift."/>

<meta property="og:title" content="Using the iOS Keychain in Swift" />
<meta property="og:description" content="Learn how to use the iOS Keychain in Swift." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.andyibanez.com/posts/using-ios-keychain-swift/" />
<meta property="article:published_time" content="2020-05-27T07:00:00-04:00" />
<meta property="article:modified_time" content="2020-05-27T07:00:00-04:00" /><meta property="og:site_name" content="Andy Ibanez - iOS Developer" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.e4368406c047b72036bd31fdf69f74f805156724914c166a0accb2369a218b61.css" integrity="sha256-5DaEBsBHtyA2vTH99p90&#43;AUVZySRTBZqCsyyNpohi2E=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    <script data-ad-client="ca-pub-3640551804216350" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-146179797-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.andyibanez.com">Andy Ibanez</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/196dd48d2ac425661edf58028d499370?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Software Developer from La Paz, Bolivia. Programming for iOS since 2011. 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Andy Ibanez</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/wwdc2020/">
						<span>WWDC 2020</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/projects/">
						<span>Projects</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About Me</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/privacy-policy/">
						<span>Privacy Policy</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/AndyIbanezK" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://facebook.com/AndyIbanezCom" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/andyibanez" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/andyibanez" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/andr%c3%a9s-iba%c3%b1ez-30234033" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/648767" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://keybase.io/andyibanez" rel="me"><i class="fab fa-keybase fa-lg" aria-hidden="true"></i></a>
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2021 Andrés Ibañez
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Using the iOS Keychain in Swift</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 27, 2020
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/development">DEVELOPMENT</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/swift">swift</a>
           
      
          <a class="badge badge-tag" href="/tags/programming">programming</a>
           
      
          <a class="badge badge-tag" href="/tags/apple">apple</a>
           
      
          <a class="badge badge-tag" href="/tags/ios">ios</a>
           
      
          <a class="badge badge-tag" href="/tags/macos">macos</a>
           
      
          <a class="badge badge-tag" href="/tags/tvos">tvos</a>
           
      
          <a class="badge badge-tag" href="/tags/watchos">watchos</a>
           
      
          <a class="badge badge-tag" href="/tags/ipados">ipados</a>
           
      
          <a class="badge badge-tag" href="/tags/keychain">keychain</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 13 min read
</div>


  </header>
  
  
  <div class="post">
    <p><em>This article is an entirely rewritten version of an old tutorial I wrote years ago titled &ldquo;Using the iOS Keychain&rdquo;. Originally written in Objective-C, the old version has been archived but it is accessible <a href="https://www.andyibanez.com/old-content/">here</a>.</em></p>
<p>The Keychain is the place where you would store sensitive data. As secure as iOS currently is, the keychain is the right place to store passwords, authentication tokens, and other sensitive data. You should not store this kind of data in <code>UserDefaults</code>, even if iOS has made it harder to access that data for normal users in the latest versions.</p>
<p>In this article we will explore how to use the iOS keychain (which is also applicable to iPadOS, watchOS, and even tvOS) using Swift. The APIs are similar to the ones used in macOS, but the way both systems work with their keychain is different enough to consider them separate. The keychain APIs are very old and as such we will be written some &ldquo;ugly&rdquo; Swift code to get everything to work, although these days it&rsquo;s much easier to do the bridging to Core Foundation and back. With that said, using the keychain isn&rsquo;t too hard, and you should use it if you find yourself needing to store sensitive data.</p>
<h1 id="basic-keychain-concepts">Basic Keychain Concepts</h1>
<p>Before we write some code, we need to get some terminology down. Keep these concepts in mind as you read through this article:</p>
<ul>
<li><strong>Keychain</strong>: The keychain is a secure and encrypted storage place for sensitive data. You can think of it is a database of sensitive information.</li>
<li><strong>Keychain Item</strong>: This is a registry in the keychain.</li>
<li><strong>Item Class</strong>: You can think of a class as a template of information you want to store. The keychain offers classes for different common credentials, such as username/password pairs, a certificate, a generic password, and more.</li>
</ul>
<p>Please note that the keychain is tied to the developer provisioning profile used to sign the app and its bundle ID. If either of these change, the data becomes inaccessible.</p>
<h1 id="common-keychain-operations">Common Keychain Operations</h1>
<p>With that basic terminology out of the way, we can start doing basic operations: Adding new items to the keychain, searching for specific items, updating items, and deleting items.</p>
<p>First things first, the keychain services are part of the <code>Security</code> framework, so don&rsquo;t forget to add that import:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"># <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Security</span>
</code></pre></div><h2 id="adding-items-to-the-keychain">Adding Items to the Keychain</h2>
<h3 id="adding-items">Adding Items</h3>
<p>To add items to the keychain, you use the <code>SecItemAdd</code> function. Again, these APIs are very old, so you may be surprised by what they take as arguments and what they return. The first parameter is a dictionary known as a <em>query</em>. The query specifies the data the keychain item will hold along with parameters we can use to find it - more on that later. Being an old (and low level) API, this argument is actually a <code>CFDictionary</code>.</p>
<p>At the very least, the keychain item should have:</p>
<ul>
<li>The item class, specified with the <code>kSecClass</code> key.</li>
<li>The actual data you want to hold, whether it is a plain password, or anything else. This should be stored as <code>Data</code> (or if you prefer, <code>CFData</code>). The key is <code>kSecValueData</code>.</li>
</ul>
<p>You can specify optional attributes and optional return types as well. We will see these in a bit.</p>
<p>The second parameter to this function is a <code>UnsafeMutablePointer&lt;CFTypeRef&gt;?</code> which may contain the data created. This is an unsafe generic pointer. This is low level stuff, but I promise it will make sense later.</p>
<p>This parameter makes more sense when are retrieving items from the keychain, but if you wanted to return the item you just created to check its data or do anything else with it, you can use this parameter to return it after creating it.</p>
<p>The function itself returns an <code>OSStatus</code>. <code>OSStatus</code> tells us the status of the operation we just performed, and you will see it in all the keychain APIs. If it returns <code>0</code> (or <code>errSecSuccess</code>), the operation finished successfully and our operation finished without an issue. In the case of <code>SecItemAdd</code>, that will mean our new item was added to the keychain.</p>
<p>To create a keychain item, this is the minimum code you would need:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> keychainItemQuery = [
  kSecValueData: <span style="color:#e6db74">&#34;Pullip2020&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>,
  kSecClass: kSecClassGenericPassword
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> status = SecItemAdd(keychainItemQuery, <span style="color:#66d9ef">nil</span>)
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>This will work fine, and it will print <code>0</code> for the status which is what we would expect (Yes, <code>OSStatus</code> is not bridged to Swift yet, so you won&rsquo;t get the actual enum case name <code>errSecSuccess</code>). The problem with this code is that searching for this item later will be a bit harder. We will explore why when we explore how to retrieve items, but for now, try to add more context to your new items. We can do this by adding optional attributes. All the attributes we can use are also dictionary keys that have the <code>kSecAttr</code> prefix.</p>
<p>Different classes have different attributes that make the keys unique. When using <code>kSecClassInternetPassword</code>, we can specify a username and the domain name of the website. Note that we are passing <code>nil</code> to the second argument, because we aren&rsquo;t interested in returning the newly created item just yet.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> keychainItem = [
  kSecValueData: <span style="color:#e6db74">&#34;Pullip2020&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez&#34;</span>,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecClass: kSecClassInternetPassword
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> status = SecItemAdd(keychainItem, <span style="color:#66d9ef">nil</span>)
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><h3 id="retrieving-newly-added-records">Retrieving Newly-Added Records.</h3>
<p><code>SecItemAdd</code> has a second argument we can use to return the newly created item if we want to use it instantly. This parameter is called <code>result</code>, and you will probably specify <code>nil</code> here most of the time, but it&rsquo;s good to know that this function can return data after adding items, in case you ever need it.</p>
<p>When we create a new item, we can specify four different return types that will be filled in the second argument. Remember this parameter is of type <code>UnsafeMutablePointer&lt;CFTypeRef&gt;?</code>, so it can result a pointer that can point to pretty much anything. This is a big mess, so we will explain the different return types before we move on. All the return types are specified with a key in the query that has the prefix <code>kSecReturn</code>.</p>
<ul>
<li><code>kSecReturnRef</code>: When this is set to <code>true</code>, <code>result</code> will point to either a <code>SecKeychainItem</code>, <code>SecKey</code>, <code>SecCertificate</code>, <code>SecIdentity</code>, or <code>CFData</code>, depending on the <code>kSecClass</code> specified in the query. I couldn&rsquo;t get this to return anything on iOS.</li>
<li><code>kSecReturnPersistentRef</code>: When this is set to <code>true</code>, <code>result</code> will contain <code>CFData</code> which you can use to persist on disk or pass to different processes.</li>
<li><code>kSecReturnData</code>: When this is set to <code>true</code>, this will return the actual sensitive data stored in the keychain item. The sensitive data will vary on the item class, but if your query contains a <code>kSecValueData</code> key, it will return that.</li>
<li><code>kSecReturnAttributes</code>: This will return all the attributes used to create the item in a <code>CFDictionary</code>.</li>
</ul>
<p>So&hellip; Yes, it is a mess. The API is very old, and <code>result</code> can be pretty much anything. This API is not really friendly with Swift&rsquo;s type safety, so we have to do a lot of casting when working with keychain services.</p>
<p><code>CFTypeRef</code> is bridged to <code>AnyObject</code>, so you can forget about <code>CFTypeRef</code> and use <code>AnyObject</code> everywhere instead.</p>
<p>Here is an example of a query that returns the attributes, using <code>kSecReturnAttributes</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> keychainItem = [
  kSecValueData: <span style="color:#e6db74">&#34;Pullip2020&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez&#34;</span>,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecClass: kSecClassInternetPassword,
  kSecReturnAttributes: <span style="color:#66d9ef">true</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">var</span> ref: AnyObject?

<span style="color:#66d9ef">let</span> status = SecItemAdd(keychainItem, &amp;ref)
<span style="color:#66d9ef">let</span> result = ref <span style="color:#66d9ef">as</span>! NSDictionary
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
print(<span style="color:#e6db74">&#34;Returned attributes:&#34;</span>)
result.forEach { key, value <span style="color:#66d9ef">in</span>
  print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>key<span style="color:#e6db74">)</span><span style="color:#e6db74">: </span><span style="color:#e6db74">\(</span>value<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
}
</code></pre></div><p>This will print:</p>
<pre><code>Operation finished with status: 0
Returned attributes:
acct: andyibanez
atyp: 
sha1: {length = 20, bytes = 0x589a101265fbb5cd7b596657d2109c13450533a1}
path: 
sdmn: 
pdmn: ak
mdat: 2020-05-24 19:33:51 +0000
sync: 0
cdat: 2020-05-24 19:33:51 +0000
ptcl: 0
srvr: pullipstyle.com
agrp: 7X7FABXK4C.com.andyibanez.keychain
port: 0
</code></pre><p>You will never use these keys directly. Always use the proper <code>kSecAttr</code> key to get your data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">print(<span style="color:#e6db74">&#34;Website: </span><span style="color:#e6db74">\(</span>result[kSecAttrServer] ?? <span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e">// Website: pullipstyle.com</span>
</code></pre></div><p>You may have noticed the actual password is missing. To get the password, we need to specify the <code>kSecReturnData</code> key instead. <code>kSecReturnData</code> returns a <code>CFData</code>, and <code>kSecReturnAttributes</code> returns a dictionary, so they are incompatible types to begin with.</p>
<p>To retrieve the password itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> keychainItem = [
  kSecValueData: <span style="color:#e6db74">&#34;Pullip2020&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez&#34;</span>,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecClass: kSecClassInternetPassword,
  kSecReturnData: <span style="color:#66d9ef">true</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">var</span> ref: AnyObject?

<span style="color:#66d9ef">let</span> status = SecItemAdd(keychainItem, &amp;ref)
<span style="color:#66d9ef">let</span> result = ref <span style="color:#66d9ef">as</span>! Data
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">let</span> password = String(data: result, encoding: .utf8)<span style="color:#f92672">!</span>
print(<span style="color:#e6db74">&#34;Password: </span><span style="color:#e6db74">\(</span>password<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><pre><code>Password: Pullip2020
</code></pre><p>&hellip; But, you can actually return both at the same time! Even though using <code>kSecReturnData</code> and <code>kSecReturnAttributes</code> return different types, if you specify both keys at the same time and set them to true, <code>SecItemAdd</code> will return a <code>CFDictionary</code> that contains the attributes <em>and</em> the password. So, if you are aiming for consistency, and you always want <code>result</code> to have the same data type, if you specify more than one return key, you will always get a dictionary back.</p>
<pre><code>let keychainItem = [
  kSecValueData: &quot;Pullip2020&quot;.data(using: .utf8)!,
  kSecAttrAccount: &quot;andyibanez&quot;,
  kSecAttrServer: &quot;pullipstyle.com&quot;,
  kSecClass: kSecClassInternetPassword,
  kSecReturnData: true,
  kSecReturnAttributes: true
] as CFDictionary

var ref: AnyObject?

let status = SecItemAdd(keychainItem, &amp;ref)
let result = ref as! NSDictionary
print(&quot;Operation finished with status: \(status)&quot;)
print(&quot;Username: \(result[kSecAttrAccount] ?? &quot;&quot;)&quot;)
let passwordData = result[kSecValueData] as! Data
let passwordString = String(data: passwordData, encoding: .utf8)
print(&quot;Password: \(passwordString ?? &quot;&quot;)&quot;)
</code></pre><pre><code>Operation finished with status: 0
Username: andyibanez
Password: Pullip2020
</code></pre><h2 id="retrieving-items-from-the-keychain">Retrieving Items from the Keychain</h2>
<p>In this section we will explore how to write queries that retrieve data from the keychain. If you want to work along, I have written this small piece of code that will populate the keychain with different but similar entries:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> usernames = [<span style="color:#e6db74">&#34;andyibanez&#34;</span>, <span style="color:#e6db74">&#34;alice&#34;</span>, <span style="color:#e6db74">&#34;eileen&#34;</span>, <span style="color:#e6db74">&#34;blackberry&#34;</span>]

usernames.forEach { username <span style="color:#66d9ef">in</span>
  <span style="color:#66d9ef">let</span> keychainItem = [
    kSecValueData: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>username<span style="color:#e6db74">)</span><span style="color:#e6db74">-Pullip2020&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>,
    kSecAttrAccount: username,
    kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
    kSecClass: kSecClassInternetPassword,
    kSecReturnData: <span style="color:#66d9ef">true</span>,
    kSecReturnAttributes: <span style="color:#66d9ef">true</span>
  ] <span style="color:#66d9ef">as</span> CFDictionary
  
  <span style="color:#66d9ef">var</span> ref: AnyObject?
  
  <span style="color:#66d9ef">let</span> status = SecItemAdd(keychainItem, &amp;ref)
  <span style="color:#66d9ef">let</span> result = ref <span style="color:#66d9ef">as</span>! NSDictionary
  print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
  print(<span style="color:#e6db74">&#34;Username: </span><span style="color:#e6db74">\(</span>result[kSecAttrAccount] ?? <span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
  <span style="color:#66d9ef">let</span> passwordData = result[kSecValueData] <span style="color:#66d9ef">as</span>! Data
  <span style="color:#66d9ef">let</span> passwordString = String(data: passwordData, encoding: .utf8)
  print(<span style="color:#e6db74">&#34;Password: </span><span style="color:#e6db74">\(</span>passwordString ?? <span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
}
</code></pre></div><p>To query the keychain and retrieve the items, we use the <code>SecItemCopyMatching</code> function. The two parameters it takes are actually the same ones as <code>SecItemAdd</code>. The way these two functions is the same: You specify a query, and get something in return, including nil. it returns a <code>OSStatus</code> like <code>SecItemAdd</code>.</p>
<p>While <code>SecItemCopyMatching</code> has an optional second parameter, you probably want to specify it most of the time, otherwise you will never get any data back when working with it.</p>
<p>You write your query the same way you did when creating items, but there&rsquo;s a few things we need to keep in mind. First, the queries can be as specific or as generic as you want. Second, you can force the keychain to return one or more items at once.</p>
<p>Once again this API is messy, because the <code>result</code> can once again return more than one type. The conditions are the same as when returning data from <code>SecItemAdd</code>, but there is one more type <code>SecItemCopyMatching</code> can return. If you specify the key <code>kSecMatchLimit</code> and give it a value bigger than <code>1</code>, you will get a <code>CFArray</code> of <code>CFDictionary</code>.</p>
<p>Let&rsquo;s see this in action. You know you have many items that have <code>pullipstyle.com</code> as their <code>kSecAttrServer</code>. Despite that, the following query will only return one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecReturnAttributes: <span style="color:#66d9ef">true</span>,
  kSecReturnData: <span style="color:#66d9ef">true</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">var</span> result: AnyObject?
<span style="color:#66d9ef">let</span> status = SecItemCopyMatching(query, &amp;result)

print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">let</span> dic = result <span style="color:#66d9ef">as</span>! NSDictionary

<span style="color:#66d9ef">let</span> username = dic[kSecAttrAccount] ?? <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">let</span> passwordData = dic[kSecValueData] <span style="color:#66d9ef">as</span>! Data
<span style="color:#66d9ef">let</span> password = String(data: passwordData, encoding: .utf8)<span style="color:#f92672">!</span>
print(<span style="color:#e6db74">&#34;Username: </span><span style="color:#e6db74">\(</span>username<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
print(<span style="color:#e6db74">&#34;Password: </span><span style="color:#e6db74">\(</span>password<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>If the query doesn&rsquo;t find any items to return, <code>result</code> will be nil, so make sure you check for that.</p>
<p>To return more than one, we will specify <code>kSecMatchLimit</code> to a high enough number to return all the entries:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecReturnAttributes: <span style="color:#66d9ef">true</span>,
  kSecReturnData: <span style="color:#66d9ef">true</span>,
  kSecMatchLimit: <span style="color:#ae81ff">5</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">var</span> result: AnyObject?
<span style="color:#66d9ef">let</span> status = SecItemCopyMatching(query, &amp;result)

print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">let</span> array = result <span style="color:#66d9ef">as</span>! [NSDictionary]

array.forEach { dic <span style="color:#66d9ef">in</span>
  <span style="color:#66d9ef">let</span> username = dic[kSecAttrAccount] ?? <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#66d9ef">let</span> passwordData = dic[kSecValueData] <span style="color:#66d9ef">as</span>! Data
  <span style="color:#66d9ef">let</span> password = String(data: passwordData, encoding: .utf8)<span style="color:#f92672">!</span>
  print(<span style="color:#e6db74">&#34;Username: </span><span style="color:#e6db74">\(</span>username<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
  print(<span style="color:#e6db74">&#34;Password: </span><span style="color:#e6db74">\(</span>password<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
}
</code></pre></div><p>Now the code has been adapted to work with an array instead of a dictionary, and we can now get all the entries that match the query.</p>
<p>One annoying detail of specifying <code>kSecMatchLimit</code> is that when your query produces zero results, <code>result</code> will again be <code>nil</code> instead of an empty array, so keep that in mind.</p>
<p>The more attribute keys you add, the more specific your queries become.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez&#34;</span>,
  kSecReturnAttributes: <span style="color:#66d9ef">true</span>,
  kSecReturnData: <span style="color:#66d9ef">true</span>,
  kSecMatchLimit: <span style="color:#ae81ff">5</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">var</span> result: AnyObject?
<span style="color:#66d9ef">let</span> status = SecItemCopyMatching(query, &amp;result)

print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">let</span> array = result <span style="color:#66d9ef">as</span>! [NSDictionary]

array.forEach { dic <span style="color:#66d9ef">in</span>
  <span style="color:#66d9ef">let</span> username = dic[kSecAttrAccount] ?? <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#66d9ef">let</span> passwordData = dic[kSecValueData] <span style="color:#66d9ef">as</span>! Data
  <span style="color:#66d9ef">let</span> password = String(data: passwordData, encoding: .utf8)<span style="color:#f92672">!</span>
  print(<span style="color:#e6db74">&#34;Username: </span><span style="color:#e6db74">\(</span>username<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
  print(<span style="color:#e6db74">&#34;Password: </span><span style="color:#e6db74">\(</span>password<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
}
</code></pre></div><p>The above code will match both the server (<code>pullipstyle.com</code>) and the username (<code>andyibanez</code>). This returns one item only in our specific case. Luckily since <code>kSecMatchLimit</code> is bigger than one, we still get an array and not a dictionary.</p>
<pre><code>Operation finished with status: 0
Username: andyibanez
Password: andyibanez-Pullip2020
</code></pre><h2 id="updating-items">Updating Items</h2>
<p>To update items in the keychain, you use the <code>SecItemUpdate</code> function which also returns an <code>OSStatus</code>. Unlike <code>SecItemAdd</code> and <code>SecItemCopyMatching</code>, this function takes two <code>CFDictionaries</code> as its arguments. The first one is the query which you know and love. The second one contains the attributes you want to update and their new values.</p>
<p>When specifying the query, you really need to be careful with how specific it is. If it isn&rsquo;t specific enough, you may end up updating multiple items at once when you didn&rsquo;t intend to.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> updateFields = [
  kSecValueData: <span style="color:#e6db74">&#34;newPassword&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> status = SecItemUpdate(query, updateFields)
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>This will successfully modify the password of all <code>kSecClass</code>es whose <code>kSecAttrServer</code> is <code>pullipstyle.com</code>. It will update ALL the entries, because our query is too general and it matches many entries. Always try to make the query more specific to avoid these problems, especially if your keychain stores a lot of sensitive data.</p>
<p>In this case it would better to also specify the username (<code>kSecAttrAccount</code>) of the user we want to update:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstylew.com&#34;</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez&#34;</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> updateFields = [
  kSecValueData: <span style="color:#e6db74">&#34;newPassword&#34;</span>.data(using: .utf8)<span style="color:#f92672">!</span>
] <span style="color:#66d9ef">as</span> CFDictionary

<span style="color:#66d9ef">let</span> status = SecItemUpdate(query, updateFields)
print(<span style="color:#e6db74">&#34;Operation finished with status: </span><span style="color:#e6db74">\(</span>status<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><h2 id="deleting-items">Deleting Items</h2>
<p>To delete an item, use the <code>SecItemDelete</code> function. This function only takes one parameter, the query, and returns an <code>OSStatus</code>.</p>
<p>Just like when we are updating items, make sure your query is very specific so you only delete what you intend to delete. If you don&rsquo;t you may delete extra entries accidentally.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> query = [
  kSecClass: kSecClassInternetPassword,
  kSecAttrServer: <span style="color:#e6db74">&#34;pullipstyle.com&#34;</span>,
  kSecAttrAccount: <span style="color:#e6db74">&#34;andyibanez.com&#34;</span>
] <span style="color:#66d9ef">as</span> CFDictionary

SecItemDelete(query)
</code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>Using the keychain to store sensitive data is the way to go. While it is a low-level API, the bridging to Swift has become more bearable in the last few years. You generally won&rsquo;t worry too much about the bridging types, but it&rsquo;s worth keeping into amount that the operations that return data back can return different data types.</p>
<p>We explored the basic usage of the keychain services APIs. We learend how to add, search, update, and delete entries, but the keychain can actually do quite a lot more than just that. Hopefully this article helped you get started to write more secure storage for sensitive data in your own apps.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/content-blockers-in-ios/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Writing Content Blockers for iOS</span>
    </a>
    
    
    <a href="/posts/ios-keychain-touch-id-face-id/" class="navigation-next">
      <span class="navigation-tittle">Using the iOS Keychain with Biometrics</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="AndyIbanez/andyibanez-com"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146179797-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/swift.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/objectivec.min.js"></script>
            
        
    
    <script type="text/javascript">
        
        hljs.configure({languages: ["swift, objectivec"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
